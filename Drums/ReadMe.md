# SynthelicZ Drums ‚Äî ABC Groove Editor & Player

## Purpose

A browser-based drum groove editor and player that lets musicians create, visualize, and play back drum patterns using multiple input methods ‚Äî from traditional sheet notation to Guitar Hero-style falling lanes ‚Äî all wrapped in a visually stunning, 60 fps animated interface. The application is a single-page HTML/JS app hosted on GitHub Pages, powered by the [abcjs](https://www.abcjs.net/) library for sheet music rendering and MIDI playback.

## How It Works (High-Level)

1. **Data Model** ‚Äî Grooves are sequences of `Bar` objects, each containing 16 `DrumBit` slots (one per 1/16th note). Every DrumBit is a single byte encoding the state of the entire drum kit at that instant (see *Encoding Reference* below).
2. **Rendering Pipeline** ‚Äî The internal model is converted to ABC notation via `AbcConverter`, rendered as sheet music by abcjs, and played back through the Web Audio / Web MIDI API.
3. **Input Layer** ‚Äî Multiple interchangeable input modes feed the same underlying data model.
4. **Visual Layer** ‚Äî A GPU-accelerated canvas overlay provides particle effects, hit animations, and smooth transitions at 60 fps using `requestAnimationFrame`.

### Integrated Layout Concept

The main view is a single integrated screen. The right panel is split into a **tabbed upper area** (Sheet / Bar Editor) and a **transport-belt strip** at the bottom. The belt sits at the same height as the drum kit on the left, so notes scroll right ‚Üí left along the belt and visually feed into the kit. Each note's vertical position on the belt maps to the physical drum/cymbal at the same height in the kit, so even users unfamiliar with sheet notation can see exactly which instrument every note triggers.

```text
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                       Transport Bar                          ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ              ‚îÇ  ‚îå‚îÄ [üéº Sheet] [üéõÔ∏è Bar Editor] ‚îÄ‚îÄ tabs ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ              ‚îÇ  ‚îÇ                                         ‚îÇ  ‚îÇ
‚îÇ  ‚îå Falling ‚îê ‚îÇ  ‚îÇ  Full Score (abcjs) / Bar Editor        ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ Lanes   ‚îÇ ‚îÇ  ‚îÇ                                         ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ ‚Üì ‚Üì ‚Üì ‚Üì ‚îÇ ‚îÇ  ‚îÇ                                         ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ ‚Üì ‚Üì ‚Üì ‚Üì ‚îÇ ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ  ‚îå‚îÄ Sheet Belt (scroll right ‚Üí left) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îå‚îÄ Drum ‚îÄ‚îÄ‚îê ‚îÇ  ‚îÇ  ‚ô©  ‚ô©‚ô© ‚ô©   ‚ô©‚ô©  ‚ô©  ‚ô©‚ô© ‚ô©  ‚ô©  ‚ô©           ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ Kit SVG ‚îÇ‚óÑ‚îú‚îÄ‚îÄ‚î§  notes fly left into kit                ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ (hit    ‚îÇ ‚îÇ  ‚îÇ  vertical position = instrument         ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  zones) ‚îÇ ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ                                               ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                Mixer / Controls / Status                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

* **Left panel (top)** ‚Äî Guitar Hero-style falling lanes scroll downward; lanes are arranged left-to-right to match the physical kit layout. Notes drop into the kit and trigger hit animations upon arrival.
* **Left panel (bottom)** ‚Äî The procedural SVG drum kit (generated by `kit-renderer.js` with interactive hit-zones).
* **Right panel (top)** ‚Äî A **tabbed area** with three views:
  * **Sheet tab** ‚Äî Full abcjs-rendered score.
  * **Bar Editor tab** ‚Äî Direct bar-level grid editor for composing / editing bars (10 instruments √ó 16 sixteenth notes, click-to-cycle, bar navigation).
  * **ABC tab** ‚Äî Raw ABC notation text (monospace, selectable) showing the current groove in standard ABC format for copying, sharing, or reference.
* **Right panel (bottom)** ‚Äî The **transport-belt sheet**: one endless, horizontally scrolling line of notes. Notes travel right ‚Üí left and visually enter the drum kit at the left edge. Sits at the same height as the kit so the two are visually connected.
* **Top** ‚Äî Unified transport bar with abcjs playback controls (Play / Pause / Stop / Loop / Progress / Warp) plus New / Random / MIDI / Record buttons and BPM input.
* **Bottom** ‚Äî Mixer strip, status info, and secondary controls.

## Build / Test / Run Guidelines

| Action          | Command                                                                                            |
| --------------- | -------------------------------------------------------------------------------------------------- |
| **Run locally** | Open `ABCPlayer.html` directly from the file system (`file://`) in any modern browser ‚Äî no web server required. For MIDI import features a local HTTP server may be needed. |
| **Run tests**   | Open `tests/index.html` in a browser.                                                              |
| **Deploy**      | Push to `main`; GitHub Pages serves from repository root.                                          |

> No build step is required ‚Äî the project is vanilla HTML + JS + CSS.

## High-Level Structure & Architecture

```text
Drums/
‚îú‚îÄ‚îÄ ABCPlayer.html        # Main application entry point (markup + bootstrap)
‚îú‚îÄ‚îÄ controller.js         # Application controller ‚Äî wiring, event handling, view orchestration
‚îú‚îÄ‚îÄ styles.css            # All styling, animations, transitions, theming
‚îú‚îÄ‚îÄ DrumKit.png           # Reference image for drum kit layout
‚îú‚îÄ‚îÄ ReadMe.md             # This document
‚îú‚îÄ‚îÄ model.js              # DrumBit, Bar, DrumGroove data model
‚îú‚îÄ‚îÄ abc-converter.js      # Model ‚Üî ABC notation adapter (bidirectional: convert + parseAbc)
‚îú‚îÄ‚îÄ kit-renderer.js       # Procedural SVG drum kit with clickable hit-zones & hit animations
‚îú‚îÄ‚îÄ lane-renderer.js      # Guitar Hero falling-lane canvas renderer
‚îú‚îÄ‚îÄ belt-renderer.js      # Transport-belt horizontal scrolling sheet renderer
‚îú‚îÄ‚îÄ bar-editor.js         # Interactive bar-level grid editor (click-to-cycle cells, bar nav)
‚îú‚îÄ‚îÄ note-flight.js        # Full-screen projectile overlay (belt/lane notes fly into kit pads)
‚îú‚îÄ‚îÄ AbcReference.md       # ABC notation & abcjs API quick reference for percussion
‚îú‚îÄ‚îÄ tests/                # Test harness (browser-based)
‚îÇ   ‚îú‚îÄ‚îÄ index.html        # Test runner page
‚îÇ   ‚îú‚îÄ‚îÄ test-runner.js    # Minimal xUnit-style test framework
‚îÇ   ‚îú‚îÄ‚îÄ model.test.js     # Model unit tests
‚îÇ   ‚îú‚îÄ‚îÄ abc-converter.test.js  # Converter tests
‚îÇ   ‚îú‚îÄ‚îÄ controller.test.js     # Controller integration tests
‚îÇ   ‚îú‚îÄ‚îÄ kit-renderer.test.js   # Kit renderer tests
‚îÇ   ‚îú‚îÄ‚îÄ lane-renderer.test.js  # Lane renderer tests
‚îÇ   ‚îú‚îÄ‚îÄ sheet-belt.test.js     # Sheet-belt renderer tests
‚îÇ   ‚îú‚îÄ‚îÄ bar-editor.test.js     # Bar editor tests
‚îÇ   ‚îî‚îÄ‚îÄ note-flight.test.js   # Note-flight overlay tests
‚îú‚îÄ‚îÄ midi-io.js            # (planned) MIDI import / export logic
‚îú‚îÄ‚îÄ audio-engine.js       # (planned) Web Audio playback, sample management, mixer
‚îî‚îÄ‚îÄ input-handler.js      # (planned) Keyboard/touch/MIDI input routing
```

> **Convention:** additional JavaScript files live next to `controller.js` in the project root. Each file owns one responsibility. `ABCPlayer.html` loads all scripts via plain `<script>` tags in dependency order (no ES modules, so the app works from `file://` without a web server).

### Architectural Patterns

* **Multi-file vanilla JS with IIFE namespacing** ‚Äî logic is split across focused `.js` files, each wrapped in an IIFE that reads from / writes to a shared global namespace `window.SZDrums`. Scripts are loaded in dependency order via plain `<script>` tags in `ABCPlayer.html`. This avoids ES module `import`/`export`, which requires a web server due to CORS restrictions on `file://`. `controller.js` is the last script loaded and wires everything together.
* **Model ‚Üî View separation** ‚Äî `DrumBit`, `Bar`, `DrumGroove` (model) ‚áÑ `AbcConverter` (adapter) ‚áÑ abcjs renderer + lane renderer + kit renderer (views).
* **Strategy pattern for input modes** ‚Äî each input method implements a common interface that writes to the shared `DrumGroove` model.
* **Render loop** ‚Äî a dedicated `requestAnimationFrame` loop drives falling lanes, kit animations, the note-flight overlay, and belt scrolling independently of the music-playback timer.
* **CSS-driven theming** ‚Äî all colors, transitions, and animation timing live in `styles.css` using custom properties, enabling future theme switching.

---

## Full Feature Set

### Currently Implemented ‚úÖ

* Binary DrumBit encoding/decoding (drumset mode + toms mode).
* `Bar` and `DrumGroove` model classes with clone support.
* ABC notation conversion and rendering via abcjs.
* Playback with cursor tracking and note highlighting.
* Click-to-audition individual notes.
* MIDI file download.
* Random groove generation (`?mode=random`).
* Load external ABC files via `?uri=` parameter with full model reconstruction (ABC ‚Üí DrumGroove parser populates bar editor, belt, lanes, and enables recording/editing on imported grooves).
* Modular architecture: `model.js`, `abc-converter.js`, `controller.js`, `styles.css` (ES modules).
* Dark-neon themed responsive layout with CSS custom properties (with light mode alternative).
* Integrated layout shell: transport bar, left panel (lanes + kit), right panel (tabbed Sheet/Bar Editor + belt at kit height), mixer.
* **Tabbed editor area**: Sheet tab (full abcjs score + playback controls) and Bar Editor tab with click-to-switch tab bar.
* **Bar Editor** (`bar-editor.js`): interactive grid (10 instrument rows √ó 16 sixteenth-note columns) for composing/editing patterns bar-by-bar. Click cells to cycle through per-instrument PlayStates (Silence ‚Üí Stroke ‚Üí Ghost ‚Üí Accent ‚Üí etc.). Toolbar with prev/next navigation, add/duplicate/delete bar controls. Real-time sync ‚Äî edits immediately update the ABC score, sheet belt, and falling lanes. *(Epics S-03, S-04, S-05)*
* Browser-based test harness with model, converter, controller, and renderer tests.
* All known setter bugs fixed (`&` ‚Üí `|`, typos, missing `break`, completed TODO stubs).
* **Procedural SVG drum kit** (`kit-renderer.js`): 10 instrument hit-zones (crash, ride, closed/open hi-hat, hi-hat pedal, 3 toms, snare, kick) with stand/pedal hardware, clickable pads that trigger sounds via abcjs, hit animations with glow effects. Positions are derived from a 10√ó10 matrix: LR column order (HH,OH,CH,SN,CR,HT,BD,MD,LT,RI) √ó TB row order (CR,OH,HH,RI,HT,MT,SN,LT,BD,CH) ‚Üí `cx = 30 + col√ó37.8`, `cy = 20 + row√ó28.9` inside the 400√ó300 viewBox. Hardware lines (stands, pedals, legs) are dynamically derived from pad positions so they follow any layout changes. Exports `INSTRUMENT_X` (cx/400) and `INSTRUMENT_Y` (cy/300) for use by renderers. *(Epics D-01, D-02)*
* **Guitar Hero falling lanes** (`lane-renderer.js`): 10-lane canvas renderer with per-instrument colors, note gems that fall smoothly downward toward a hit-line via time-based beat interpolation at 60 fps, play-state styling (accent ring, ghost dash, normal opacity), hit-flash feedback, BPM-synced speed, HiDPI support. **Kit-aligned**: gems are positioned horizontally using `INSTRUMENT_X` so each gem column aligns with the drum pad directly below. When a note crosses the hit-line it fires a projectile toward the drum kit via the note-flight overlay. *(Epics G-01, G-02, G-03)*
* **Transport-belt sheet** (`belt-renderer.js`): horizontal scrolling canvas that renders a 5-line percussion staff with 2x-scaled oval/X noteheads, stems (always up), flags, and beams. Notes are positioned vertically using `INSTRUMENT_Y` (derived from the kit SVG `cy / 300`) so each note sits at the same height as the corresponding drum pad. A "Beam/Inst" checkbox in the transport bar toggles between cross-instrument and per-instrument beaming. During playback the staff scrolls smoothly left via time-based beat interpolation at 60 fps. When a note crosses the cursor it fires a projectile toward the drum kit via the note-flight overlay. *(Epics S-01, S-02)*
* **Note-flight overlay** (`note-flight.js`): full-screen canvas overlay that animates projectiles from the belt and falling lanes into the drum-kit SVG pads. Projectiles follow a quadratic B√©zier curve with a glowing trail, expand mid-flight, and on arrival trigger an expanding ring + particle burst at the pad. **Seamless handoff**: lane gems and belt notes fade out over the last 0.3 beats before reaching the hit-line / cursor, while projectiles fade in over the first 20% of their flight, creating a smooth visual transition from notation to effect. The controller wires `onArrive` to trigger the kit pad's hit animation and sound. *(Epics G-02, S-02, V-02)*
* **60 fps render loop** in `controller.js`: `requestAnimationFrame`-driven, feeds playback beat position from abcjs cursor events to all renderers (lanes, belt, note-flight overlay), wires kit hits from projectile arrival, observes play/stop state. *(Epic V-01)*
* **Keyboard recording** (`controller.js`): toggle Record mode via the transport bar button, then tap keyboard keys during playback to place notes into the groove. Taps are quantized to the nearest 1/16th note and written directly to the `DrumGroove` model. The kit animates and plays the sound on each tap. When playback stops, the ABC notation and all views sync automatically. Key mapping: `Q`=Crash, `W`=Closed HH, `E`=Ride, `Shift+E`=Ride Bell, `R`=Open HH, `T`=HH Pedal, `A`=High Tom, `S`=Snare, `D`=Mid Tom, `F`=Floor Tom, `Space`=Kick. *(Epic K-01)*
* **Bar editor follows playback** ‚Äî during playback the bar editor automatically advances to the bar currently being played, so the user always sees the bar being recorded into.
* **Playback sync via abcjs SynthController** ‚Äî the controller hooks into `onStart()`, `onFinished()`, and `onBeat()` (with subdivision 16 for tight sync) from the abcjs `CursorControl` interface. Play detection uses `onStart()`, pause detection intercepts clicks on the abcjs play button directly, and end detection uses `onFinished()`. `onBeat` is the sole source for renderer `setCurrentBeat()` calls and note-crossing detection ‚Äî `onEvent` only handles cursor highlighting, playback rate derivation, and bar editor tracking, avoiding beat ping-pong between the two sources at slow warp speeds. Playback rate is derived from consecutive abcjs event timing deltas, so renderers track the actual warp speed. A dynamic extrapolation cap (`max(150ms, 0.125/rate)`) scales with warp speed to keep renderers smooth.
* **Repeat / loop support**: beat position is wrapped modulo the groove length so notes and projectiles fire correctly on every repeat pass.
* **Play/pause icon swap**: the abcjs play button shows a triangle when stopped and two vertical bars when playing, providing clear visual feedback of the playback state.
* **Brighter transport button icons**: restart, loop, and other abcjs button SVGs use bright white (dark mode) or black (light mode) fill and stroke for improved visibility.
* **Light mode toggle**: transport bar button switches between the dark-neon theme and a light theme. Canvas renderers (belt, lanes) adapt their line and background colors. Preference is persisted in `localStorage`.

---

## Planned Features

> Features are organized into **Epics**. Each epic contains prioritized **User Stories** written as  
> *"As a \<role\>, I want \<goal\>, so that \<benefit\>."*  
> Acceptance criteria are listed beneath each story.

---

### Epic 1 ‚Äî Sheet-Music Editor (Transport-Belt Notation & Grid)

> During playback the sheet is rendered as a single endless horizontal line scrolling right ‚Üí left (the "transport belt"). Notes visually slide into the drum kit SVG, their vertical staff position aligned with the corresponding drum, so non-readers instantly see which instrument is hit. In editing mode the same strip can be paused, zoomed, and clicked to modify notes.

| ID       | Story                                                                                                                                                                                                                                                            | Priority  |
| -------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------- |
| **S-01** | As a **drummer**, I want the currently playing sheet-music line to scroll endlessly right ‚Üí left like a transport belt, feeding notes into the drum kit SVG, so that I can see upcoming notation approaching each instrument in real time.                        | üî¥ High   |
| **S-02** | As a **beginner**, I want the vertical position of notes on the staff to be visually aligned with the corresponding drum/cymbal in the SVG kit to the left, so that I can learn which note-head means which instrument without memorizing notation.               | üî¥ High   |
| **S-03** | As a **drummer**, I want to click / tap a note on the scrolling strip (or a grid cell in edit mode) to toggle a hit (cycling Silence ‚Üí Stroke ‚Üí Ghost ‚Üí Accent ‚Üí ‚Ä¶), so that I can compose patterns without a physical kit.                                     | üî¥ High   |
| **S-04** | As a **drummer**, I want the sheet to update in real time as I edit the grid or tap the kit, so that notation and model are always in sync.                                                                                                                      | üî¥ High   |
| **S-05** | As a **user**, I want to add, remove, duplicate, and reorder bars via toolbar buttons, so that I can build multi-bar grooves quickly.                                                                                                                            | üü° Medium |
| **S-06** | As a **user**, I want undo / redo (Ctrl+Z / Ctrl+Y) for all editing actions, so that mistakes are non-destructive.                                                                                                                                              | üü° Medium |
| **S-07** | As a **user**, I want to set tempo (BPM), time signature, title, and artist metadata in a header panel, so that exports are correctly annotated.                                                                                                                 | üü° Medium |
| **S-08** | As a **user**, I want an optional full-score overview (multi-line, traditional page layout) below the transport-belt strip, so that I can see the entire groove at a glance while still having the scrolling view above.                                          | üü¢ Low    |

---

### Epic 2 ‚Äî Keyboard Tapping (Real-Time Recording)

| ID       | Story                                                                                                                                                                      | Priority |
| -------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------- |
| **K-01** | ~~As a **drummer**, I want to map PC keyboard keys to drum kit instruments, so that I can tap in grooves in real time.~~ **Done** ‚Äî keys mapped: Q=Crash, W=HH, E=Ride, R=OH, T=Pedal, A=HiTom, S=Snare, D=MidTom, F=FlrTom, Space=Kick. Toggle via Record button. | ‚úÖ Done   |
| **K-02** | As a **drummer**, I want a metronome click and count-in (1-bar or 2-bar) before recording starts, so that I stay in time.                                                  | üî¥ High   |
| **K-03** | As a **drummer**, I want input quantization options (off / 1/8 / 1/16 / 1/32), so that my sloppy timing is snapped to the grid.                                            | üü° Medium |
| **K-04** | As a **drummer**, I want velocity sensitivity based on how close to the beat I hit (early = ghost, on-beat = stroke, late = accent), so that dynamics feel natural.        | üü¢ Low    |
| **K-05** | As a **user**, I want a customizable key-binding panel, so that I can remap instruments to any keys I prefer.                                                              | üü¢ Low    |

---

### Epic 3 ‚Äî MIDI Import / Export

| ID       | Story                                                                                                                                                  | Priority |
| -------- | ------------------------------------------------------------------------------------------------------------------------------------------------------ | -------- |
| **M-01** | As a **user**, I want to drag-and-drop or browse for a `.mid` file to import it as a `DrumGroove`, so that I can visualize and edit existing patterns. | üî¥ High   |
| **M-02** | As a **user**, I want the importer to auto-detect the GM drum map and map notes to internal instruments, so that standard MIDI files just work.        | üî¥ High   |
| **M-03** | As a **user**, I want to export my groove as a Standard MIDI File (Type 0, channel 10), so that I can use it in a DAW.                                 | üü° Medium |
| **M-04** | As a **user**, I want to export as `.abc` text, so that I can share notation in ABC forums.                                                            | üü° Medium |
| **M-05** | ~~As a **user**, I want to import from an ABC string pasted into a text area, so that I can load grooves shared online.~~ **Partially done** ‚Äî ABC parsing implemented (`AbcConverter.parseAbc`); `?uri=` loading now populates the model. Paste-from-textarea UI not yet wired. | üü° Medium |

---

### Epic 4 ‚Äî Guitar Hero / Falling-Lane Visualizer

> Notes fall from the top of the left panel into the drum kit SVG at the bottom. When a note crosses the hit-line (the kit surface), it triggers the corresponding instrument animation and sound.

| ID       | Story                                                                                                                                                                                                                                   | Priority |
| -------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------- |
| **G-01** | As a **player**, I want colored note gems to fall downward through lanes above the drum kit SVG, one lane per instrument, so that I can see upcoming hits approaching the kit.                                                          | üî¥ High   |
| **G-02** | As a **player**, I want notes to visually "land" on the corresponding drum/cymbal in the SVG kit when they reach the hit-line, triggering the pad's hit animation and particle burst, so that lanes and kit feel like one unified view. | üî¥ High   |
| **G-03** | As a **player**, I want the lane speed to match the current BPM, so that notes arrive at the hit-line exactly on time.                                                                                                                  | üî¥ High   |
| **G-04** | As a **player**, I want hit feedback: perfect / good / miss indicators with scoring, so that practicing is gamified.                                                                                                                    | üü° Medium |
| **G-05** | As a **player**, I want a streak counter and combo multiplier displayed prominently, so that I feel rewarded for accuracy.                                                                                                              | üü° Medium |
| **G-06** | As a **player**, I want a practice mode with adjustable speed (50 %‚Äì150 %), so that I can slow down difficult passages.                                                                                                                 | üü¢ Low    |

---

### Epic 5 ‚Äî Interactive Drum Kit (Virtual Kit View)

> The SVG drum kit is always visible in the bottom-left quadrant. It serves as both the hit-target for falling lanes and a playable instrument surface.

| ID       | Story                                                                                                                                                                                                                  | Priority |
| -------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------- |
| **D-01** | As a **drummer**, I want an on-screen SVG drum kit (derived from `DrumKit.png` ‚Äî kick, snare, hi-hat, 3 toms, crash, ride) with clickable / tappable hit-zones that produce sound, so that I can jam without hardware. | üî¥ High   |
| **D-02** | As a **drummer**, I want each pad to animate (scale bounce + glow + particle burst) on hit at 60 fps, whether triggered by click, keyboard, or an arriving lane note, so that the kit feels alive.                     | üî¥ High   |
| **D-03** | As a **drummer**, I want touch support with multi-touch (‚â• 4 simultaneous), so that I can play on a tablet.                                                                                                            | üü° Medium |
| **D-04** | As a **drummer**, I want the kit to highlight upcoming notes (from the loaded groove) as a teaching aid, so that I can learn patterns visually.                                                                        | üü° Medium |
| **D-05** | As a **drummer**, I want selectable kit skins (e.g., rock, jazz, electronic), so that the visuals and samples match my style.                                                                                          | üü¢ Low    |

---

### Epic 6 ‚Äî Visual Effects & 60 fps Animations

| ID       | Story                                                                                                                                                                                   | Priority |
| -------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------- |
| **V-01** | As a **user**, I want all UI transitions (panel open/close, tab switch, modal appear) to be smooth CSS/JS animations (‚â• 60 fps, ‚â§ 16.6 ms frame budget), so that the app feels premium. | üî¥ High   |
| **V-02** | As a **user**, I want particle bursts on drum hits (sparks on crash, dust puff on kick, ripple on snare), so that playing feels impactful.                                              | üî¥ High   |
| **V-03** | As a **user**, I want a subtle pulsing glow on the currently playing beat in every view, so that I always know where the playback is.                                                   | üü° Medium |
| **V-04** | As a **user**, I want a dark theme by default with neon accent colors, so that the app looks modern and is easy on the eyes.                                                            | üü° Medium |
| **V-05** | As a **user**, I want a waveform / spectrum analyzer visualization behind the playback controls, so that audio feedback is visual too.                                                  | üü° Medium |
| **V-06** | As a **user**, I want optional background VFX (e.g., slow parallax starfield, subtle smoke) that I can disable for performance, so that the app is visually immersive.                  | üü¢ Low    |
| **V-07** | As a **user**, I want all animations to respect `prefers-reduced-motion`, so that accessibility is maintained.                                                                          | üî¥ High   |

---

### Epic 7 ‚Äî UI / UX Chrome

> The app uses an integrated single-screen layout: drum kit + falling lanes on the left, transport-belt sheet scrolling right ‚Üí left into the kit on the right.

| ID       | Story                                                                                                                                                                                                                                                                                 | Priority  |
| -------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------- |
| **U-01** | As a **user**, I want the integrated layout (falling lanes + drum kit on the left, transport-belt sheet scrolling into the kit on the right, transport bar on top) to load by default, so that notation, kit, and lanes are all visible and spatially connected in a single screen.    | üî¥ High   |
| **U-02** | As a **user**, I want a unified transport bar (Play / Pause / Stop / Record / Loop / Tempo) pinned at the top, so that playback control is always accessible.                                               | üî¥ High   |
| **U-03** | As a **user**, I want the app to be fully responsive (mobile, tablet, desktop) ‚Äî on narrow screens the panels stack vertically, so that I can use it on any device.                                         | üü° Medium |
| **U-04** | As a **user**, I want groove presets (basic rock, shuffle, bossa nova, etc.) loadable from a dropdown, so that I can start from a template.                                                                 | üü° Medium |
| **U-05** | As a **user**, I want local-storage auto-save and a "My Grooves" library panel, so that I never lose work.                                                                                                  | üü° Medium |
| **U-06** | As a **user**, I want a shareable URL (groove encoded in a URL hash), so that I can send patterns to friends without file exchange.                                                                         | üü° Medium |
| **U-07** | As a **user**, I want keyboard shortcuts for all major actions (space=play, R=record, ‚Üê/‚Üí=prev/next bar), so that power users stay fast.                                                                    | üü¢ Low    |
| **U-08** | As a **user**, I want resizable / collapsible left and right panels, so that I can focus on one view when needed.                                                                                           | üü¢ Low    |

---

### Epic 8 ‚Äî Audio Engine Enhancements

| ID       | Story                                                                                                                 | Priority |
| -------- | --------------------------------------------------------------------------------------------------------------------- | -------- |
| **A-01** | As a **user**, I want per-instrument volume sliders and a master volume, so that I can mix the groove to taste.       | üü° Medium |
| **A-02** | As a **user**, I want selectable sample packs (acoustic, electronic, 808, lo-fi), so that the sound matches my genre. | üü° Medium |
| **A-03** | As a **user**, I want a click track (metronome) toggle with adjustable volume, so that I can practice along.          | üü° Medium |
| **A-04** | As a **user**, I want swing / shuffle amount (0 %‚Äì75 %) applied to playback, so that grooves feel human.              | üü¢ Low    |
| **A-05** | As a **user**, I want Web MIDI input support, so that I can plug in a real electronic drum kit or pad controller.     | üü¢ Low    |

---

## Known Bugs & Limitations

| #   | Description                                                                                                   | Status                                                  |
| --- | ------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------- |
| 1   | ~~`_getRightTom()` references `DrumBit.TomsRightHandMaskShift` (typo)~~ ‚Äî **Fixed** in `model.js`.           | ‚úÖ Fixed                                                 |
| 2   | ~~`setInstrument()` missing `break` statements~~ ‚Äî **Fixed** in `model.js`.                                  | ‚úÖ Fixed                                                 |
| 3   | ~~`_setHiHat()` parameter typo `hiHatSate`~~ ‚Äî **Fixed** in `model.js`.                                      | ‚úÖ Fixed                                                 |
| 4   | ~~`_setMode()` uses `&` instead of `\|` when combining bits~~ ‚Äî **Fixed** in `model.js`.                     | ‚úÖ Fixed                                                 |
| 5   | ~~Setter paths stubbed with `// TODO:`~~ ‚Äî **Completed** in `model.js`.                                      | ‚úÖ Fixed                                                 |
| 6   | No input validation on `DrumBit` constructor (invalid / reserved patterns accepted silently).                 | ‚ö†Ô∏è Limitation                                            |
| 7   | ~~UI has no responsive layout~~ ‚Äî **Implemented** in `styles.css` + `ABCPlayer.html`.                        | ‚úÖ Fixed                                                 |
| 8   | No offline support / service worker.                                                                          | ‚ÑπÔ∏è Enhancement                                           |
| 9   | ABC ‚Üí DrumGroove round-trip is lossy for toms+snare chords (mode switching) and mixed decorations (e.g., accent snare + normal HH in one beat ‚Üí both get accent on re-import). Basic drumkit-mode patterns round-trip cleanly. | ‚ö†Ô∏è Limitation |
| 10  | ~~Sheet-belt RLE merged consecutive identical percussion hits into one longer note, causing missing noteheads and desynchronized projectile firing vs. falling lanes~~ ‚Äî **Fixed** in `sheet-belt.js` (removed `curSig === prevSig` from run-length merge condition). | ‚úÖ Fixed |
| 11  | ~~ABC notation hardcoded `Q:75` tempo regardless of user-selected BPM, causing audio to always play at 75 BPM while visual renderers (belt, lanes) scrolled at the selected BPM~~ ‚Äî **Fixed** in `abc-converter.js` (accept `bpm` parameter) and `controller.js` (pass `currentBpm` to every `convert()` call; regenerate ABC on tempo change). | ‚úÖ Fixed |
| 12  | ~~Changing BPM during playback called `displayABC()` ‚Üí `synthControl.setTune()`, resetting the abcjs synthesizer mid-playback and stopping audio~~ ‚Äî **Fixed** in `controller.js` (defer ABC regeneration via `_bpmDirty` flag; regenerate on playback stop). | ‚úÖ Fixed |
| 13  | ~~Belt note positions were misaligned with the drum kit~~ ‚Äî **Fixed**: belt now uses `INSTRUMENT_Y` (kit SVG `cy / 300`) directly, matching note vertical positions to drum pad heights. Staff lines pass through representative instrument rows. | ‚úÖ Fixed |
| 14  | ~~Ride cymbal had no dedicated encoding state~~ ‚Äî **Fixed** by restructuring the DrumBit encoding: right-hand channel (`rrr`) now encodes Hi-Hat (000‚Äì011) and Ride/RideBell (100‚Äì111); left-hand channel (`lll`) encodes Snare (000‚Äì100) and Crash (101‚Äì111). Ride, Ride Bell (each with accent), and Crash (with accent/choke) are now independent channels. Snare Flam/Ruff relocated to Toms mode via repurposed invalid pattern `1 000 00 rr`. | ‚úÖ Fixed |

## Security Implications

* The app runs entirely client-side with no server component ‚Äî no user data leaves the browser.
* External script loaded from `cdn.jsdelivr.net` (abcjs) ‚Äî ensure SRI hash is added for integrity.
* MIDI file import parses untrusted binary ‚Äî input validation and size limits should be enforced.
* URL-hash groove sharing must sanitize decoded data before feeding it to the model.

---

## Encoding Reference

### Basic Structure

* Grooves are divided into multiple bars.
* Each bar consists of 16 1/16th notes, known as DrumBits.
* Each DrumBit encodes the activity on the drum set using one byte.

### The Bar Encoding

* Bars contain 16 1/16th notes arranged in a specific order.
* The order is **1**, **3**, **2**, **4**, 1+, 3+, 2+, 4+, *1e*, *3e*, *2e*, *4e*, *1a*, *3a*, *2a*, *4a*.

### The 16th Notes Encoding

We use binary notation for all numbers in the DrumBit encoding.

#### DrumBit: `zxxxxxxx` where

* `z` is a mode bit
  * `0`: drumset mode
  * `1`: toms mode

#### Drumset Mode: `0lllrrrb` where

* `lll` is the snare mode
  * `000`: No action (silenced/not played)
  * `001`: Stroke (normal hit)
  * `010`: Click (Sidestick)
  * `011`: Ghost
  * `100`: Rimshot
  * `101`: Crash
  * `110`: Crash Accent
  * `111`: Crash Choke
* `rrr` is the hi-hat mode
  * `000`: No action (silenced/not played)
  * `001`: Closed Hi-Hat
  * `010`: Pedal Hi-Hat
  * `011`: Open Hi-Hat
  * `100`: Ride
  * `101`: Ride Accent
  * `110`: Ride Bell
  * `111`: Ride Bell Accent
* `b` is the bass-drum mode
  * `0`: No action (silenced/not played)
  * `1`: played

#### Toms Mode: `1mmmllrr` where

* `mmm` is selecting which toms/snare to play
  * `001`: Low Tom (LT)
  * `010`: Mid Tom (MT)
  * `100`: High Tom (HT)
  * `011`: Mid Tom + Low Tom (MT+LT)
  * `101`: High Tom + Low Tom (HT+LT)
  * `110`: High Tom + Mid Tom (HT+MT)
  * `000`: Snare + Low Tom (SN+LT)
  * `111`: Snare + High Tom (SN+HT)
* `ll` is what's played with one hand
  * `00`: No action (silenced/not played)
  * `01`: Stroke
  * `10`: Ghost
  * `11`: Accent
* `rr` is what's played with the other hand
  * `00`: No action (silenced/not played)
  * `01`: Stroke
  * `10`: Ghost
  * `11`: Accent

Hint:
When only one tom is selected (`001`, `010`, `100`), the `rr` bits encode articulation:

* `00`: normal (left hand determines Stroke/Ghost/Accent)
* `01`: Flam
* `10`: Ruff
* `11`: special (left hand determines Flam/Ruff/Rimshot)

Special Cases:

**Single tom with rr=11:**

* `ll` indicates a special treatment
  * `01`: Flam
  * `10`: Ruff
  * `11`: Rimshot

**Snare Flam/Ruff (mmm=000, ll=00):** `1 000 00 rr`

* `100000sb`
  * `s` is the snare articulation
    * `0`: Flam
    * `1`: Ruff
  * `b` is the bass-drum mode
    * `0`: No action (silenced/not played)
    * `1`: played

#### Reserved Value

* `11000000`: If we ever need to expand the encoding, this value is reserved for future use as an escape code indicating that the next byte(s) contain extended data.

#### Known Limitations

**HH Pedal + Ride can't coexist** on the same 16th note (both in right-hand channel `rrr`). Rare in practice.

#### Invalid Values

* `1000ll00` (ll!=00): two toms selected, only one played
* `11mmll00`: two toms selected, only one played
* `11mm00rr`: two toms selected, only one played
* `1011ll00`: two toms selected, only one played
